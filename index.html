<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPENft - Penguin NFT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .nft-card {
            max-width: 300px;
            margin: 20px auto;
        }

        .nft-image {
            width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center">DaPenguin NFT</h1>
        <div class="text-center mb-4">
            <button id="connectWallet" class="btn btn-primary">Connect Wallet</button>
            <p id="walletAddress" class="mt-2"></p>
        </div>

        <div class="row">
            <!-- Mint NFT Section -->
            <div class="col-md-6">
                <h3>Mint a Penguin NFT</h3>
                <button id="mintNft" class="btn btn-success mb-2" disabled>Mint NFT</button>
                <p id="mintStatus" class="text-muted"></p>
            </div>

            <!-- Flip NFT View Section -->
            <div class="col-md-6">
                <h3>Flip NFT View</h3>
                <input id="tokenIdInput" type="number" class="form-control mb-2" placeholder="Enter Token ID" min="0">
                <button id="flipView" class="btn btn-warning mb-2" disabled>Flip View</button>
                <p id="flipStatus" class="text-muted"></p>
                <p id="currentView" class="text-muted"></p>
            </div>
        </div>

        <!-- NFT Display Section -->
        <div class="text-center mt-4">
            <h3>View Your NFT</h3>
            <input id="viewTokenId" type="number" class="form-control mb-2" placeholder="Enter Token ID to View" min="0"
                style="max-width: 300px; margin: auto;">
            <button id="viewNft" class="btn btn-info mb-2" disabled>View NFT</button>
            <div id="nftDisplay" class="nft-card">
                <img id="nftImage" class="nft-image" src="" alt="NFT Image" style="display: none;">
                <p id="nftName"></p>
                <p id="nftDescription"></p>
            </div>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-6.7.0.umd.min.js"></script>
    <script>
        // Contract details
        const contractAddress = "YOUR_CONTRACT_ADDRESS"; // Replace with your deployed contract address
        const contractABI = [
            // ABI for relevant functions
            "function mintNft() public",
            "function flipView(uint256 tokenId) public",
            "function getView(uint256 tokenId) public view returns (uint8)",
            "function tokenURI(uint256 tokenId) public view returns (string)",
            "function ownerOf(uint256 tokenId) public view returns (address)"
        ];

        // zkSync Era Mainnet configuration
        const zkSyncNetwork = {
            chainId: "0x144", // 324 in hex
            chainName: "zkSync Era Mainnet",
            rpcUrls: ["https://mainnet.era.zksync.io"],
            blockExplorerUrls: ["https://explorer.zksync.io"],
            nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 }
        };

        let provider, signer, contract, userAddress;

        // DOM elements
        const connectWalletBtn = document.getElementById("connectWallet");
        const walletAddressEl = document.getElementById("walletAddress");
        const mintBtn = document.getElementById("mintNft");
        const flipBtn = document.getElementById("flipView");
        const viewBtn = document.getElementById("viewNft");
        const tokenIdInput = document.getElementById("tokenIdInput");
        const viewTokenIdInput = document.getElementById("viewTokenId");
        const mintStatus = document.getElementById("mintStatus");
        const flipStatus = document.getElementById("flipStatus");
        const currentViewEl = document.getElementById("currentView");
        const nftImage = document.getElementById("nftImage");
        const nftName = document.getElementById("nftName");
        const nftDescription = document.getElementById("nftDescription");

        // Connect wallet
        connectWalletBtn.addEventListener("click", async () => {
            if (!window.ethereum) {
                alert("Please install MetaMask!");
                return;
            }

            try {
                // Request access to accounts
                await window.ethereum.request({ method: "eth_requestAccounts" });

                // Add zkSync Era network if not present
                try {
                    await window.ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: "0x144" }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: "wallet_addEthereumChain",
                            params: [zkSyncNetwork]
                        });
                    } else {
                        throw switchError;
                    }
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(contractAddress, contractABI, signer);

                walletAddressEl.textContent = `Connected: ${userAddress}`;
                connectWalletBtn.disabled = true;
                mintBtn.disabled = false;
                flipBtn.disabled = false;
                viewBtn.disabled = false;
            } catch (error) {
                console.error(error);
                walletAddressEl.textContent = `Error: ${error.message}`;
            }
        });

        // Mint NFT
        mintBtn.addEventListener("click", async () => {
            try {
                mintStatus.textContent = "Minting...";
                const tx = await contract.mintNft();
                await tx.wait();
                mintStatus.textContent = "NFT Minted Successfully!";
            } catch (error) {
                console.error(error);
                mintStatus.textContent = `Error: ${error.message}`;
            }
        });

        // Flip NFT View
        flipBtn.addEventListener("click", async () => {
            const tokenId = tokenIdInput.value;
            if (!tokenId) {
                flipStatus.textContent = "Please enter a Token ID";
                return;
            }

            try {
                // Check if user owns the NFT
                const owner = await contract.ownerOf(tokenId);
                if (owner.toLowerCase() !== userAddress.toLowerCase()) {
                    flipStatus.textContent = "You are not the owner of this NFT";
                    return;
                }

                flipStatus.textContent = "Flipping view...";
                const tx = await contract.flipView(tokenId);
                await tx.wait();
                flipStatus.textContent = "View flipped successfully!";

                // Update current view
                const view = await contract.getView(tokenId);
                currentViewEl.textContent = `Current View: ${view === 0 ? "RIGHT" : "FRONT"}`;
            } catch (error) {
                console.error(error);
                flipStatus.textContent = `Error: ${error.message}`;
            }
        });

        // View NFT
        viewBtn.addEventListener("click", async () => {
            const tokenId = viewTokenIdInput.value;
            if (!tokenId) {
                nftName.textContent = "Please enter a Token ID";
                return;
            }

            try {
                const tokenUri = await contract.tokenURI(tokenId);
                const json = JSON.parse(atob(tokenUri.split(',')[1]));
                nftImage.src = json.image;
                nftImage.style.display = "block";
                nftName.textContent = `Name: ${json.name}`;
                nftDescription.textContent = `Description: ${json.description}`;

                // Update current view
                const view = await contract.getView(tokenId);
                currentViewEl.textContent = `Current View: ${view === 0 ? "RIGHT" : "FRONT"}`;
            } catch (error) {
                console.error(error);
                nftName.textContent = `Error: ${error.message}`;
                nftImage.style.display = "none";
            }
        });
    </script>
</body>

</html>